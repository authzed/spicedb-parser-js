---
# yamllint disable rule:line-length
name: "Publish to NPM"
on: # yamllint disable-line rule:truthy
  release:
    types:
      - "published"

permissions:
  id-token: write # Required for OIDC
  contents: read

jobs:
  publish:
    name: Publish to NPM
    runs-on: "depot-ubuntu-24.04-small"
    steps:
      - uses: actions/checkout@v6
      - uses: "pnpm/action-setup@v4"
        with:
          run_install: false
      - name: "Install Node.js"
        uses: "actions/setup-node@v6"
        with:
          registry-url: "https://registry.npmjs.org"
          cache: "pnpm"
      # Ensure npm 11.5.1 or later is installed;
      # this is required for publishing using OIDC authn
      - name: "Update npm"
        # NOTE: sudo is needed here because the original npm is installed
        # with sudo on npm images.
        run: "sudo npm install -g npm@latest"
      - name: "Install dependencies"
        run: "pnpm install"
      # Set the version in package.json to match the tag
      - name: Write release version
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          echo Version: $VERSION
          echo "VERSION=$VERSION" >> $GITHUB_ENV
      # NOTE: the flag is necessary because otherwise `npm version <version>` attempts to
      # cut a git tag with that version, which fails because the git user isn't configured.
      - name: "Update version in package.json"
        run: "pnpm version ${VERSION} --no-git-tag-version"
      - name: "Publish"
        # --provenance identifies the build as having come from github actions
        # --access public makes it publicly visible
        # --no-git-checks tells pnpm not to worry about the fact that we've changed the version
        run: "pnpm publish --provenance --access public --no-git-checks"
